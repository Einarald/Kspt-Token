<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ping Pong - KSPT</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            padding: 10px;
            background: linear-gradient(135deg, #0b0b0b 0%, #1a1a1a 100%);
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid #00bcd4;
        }
        
        .game-title {
            color: #00e676;
            font-weight: bold;
            font-size: 18px;
        }
        
        .game-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }
        
        canvas {
            background: #111;
            border: 2px solid #00bcd4;
            border-radius: 10px;
            margin-bottom: 20px;
            image-rendering: pixelated;
        }
        
        .joystick-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin-top: 20px;
        }
        
        .joystick-bg {
            width: 100%;
            height: 100%;
            background: rgba(0, 188, 212, 0.1);
            border-radius: 50%;
            position: relative;
            border: 2px solid #00bcd4;
        }
        
        .joystick-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: #00bcd4;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }
        
        .game-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }
        
        .game-buttons button {
            padding: 12px 22px;
            background: linear-gradient(135deg, #00e5ff, #00bcd4);
            color: #000;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            letter-spacing: 0.5px;
            box-shadow:
                0 0 10px rgba(0, 188, 212, 0.6),
                inset 0 0 6px rgba(255, 255, 255, 0.3);
            transition: 
                transform 0.12s ease,
                box-shadow 0.12s ease,
                filter 0.12s ease;
        }

        .game-buttons button:hover {
            filter: brightness(1.15);
        }

        .game-buttons button:active {
            transform: scale(0.94);
            box-shadow:
                0 0 4px rgba(0, 188, 212, 0.4),
                inset 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .game-buttons button:active {
            transform: scale(0.95);
        }
        
        .game-over {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00e676;
            text-align: center;
            z-index: 100;
            width: 80%;
            max-width: 300px;
        }
        
        .game-over h2 {
            color: #ff4081;
            margin-top: 0;
        }
        
        .earned {
            color: #00e676;
            font-weight: bold;
            font-size: 24px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">üèì Ping Pong</div>
            <div class="game-stats">
                <div>Player: <span id="playerScore">0</span></div>
                <div>AI: <span id="aiScore">0</span></div>
                <div>Speed: <span id="speed">100%</span></div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="360" height="360"></canvas>
        
        <div class="joystick-container" id="joystickArea">
            <div class="joystick-bg">
                <div class="joystick-center"></div>
            </div>
        </div>
        
        <div class="game-buttons">
            <button id="pauseBtn">Pause</button>
            <button id="restartBtn">Restart (-1)</button>
            <button id="exitBtn">Exit</button>
        </div>
    </div>
    
    <div class="game-over" id="gameOverScreen">
        <h2>Game Over!</h2>
        <div>Player Score: <span id="finalPlayerScore">0</span></div>
        <div>AI Score: <span id="finalAiScore">0</span></div>
        <div class="earned">+<span id="earnedKSPT">0.00</span> KSPT</div>
        <div class="earned">+<span id="earnedEK">0</span> EK</div>
        <button id="playAgainBtn" style="background:#00e676; margin-bottom:10px;">Play Again</button>
        <button id="exitToMenuBtn" style="background:#ff4081;">Exit to Menu</button>
    </div>
    
    <script>
/* ===== helper: –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–µ—Ç–æ–≤ (localStorage) ===== */
function getLocalTicketCount() {
  try {
    const raw = localStorage.getItem('kspt_tickets');
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (data && typeof data.current === 'number') return data.current;
    // –∏–Ω–æ–≥–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—ã–ª–∞ { current: N } –∏–ª–∏ { current: "N" }
    if (data && data.current != null) return Number(data.current) || 0;
  } catch (e) {
    // –µ—Å–ª–∏ iframe cross-origin ‚Äî –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –≤–µ—Ä–Ω—ë–º null (–Ω–µ –º–µ—à–∞–µ–º)
    return null;
  }
  return null;
}

function ensureHasTicketOrWarn() {
  const c = getLocalTicketCount();
  if (c === null) {
    // –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ—Å—Ç–∞—Ä—Ç (—Ä–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å)
    return true;
  }
  if (c <= 0) {
    // –µ—Å–ª–∏ –µ—Å—Ç—å postMessage handler ‚Äî —Å–æ–æ–±—â–∏–º —Ä–æ–¥–∏—Ç–µ–ª—é
    try { (window.parent || window.top).postMessage({ type: 'kspt_no_tickets' }, '*'); } catch(e){}
    // –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ / —Ç–æ—Å—Ç
    try { showToast && showToast("Not enough tickets!"); } catch(e){ alert("Not enough tickets!"); }
    return false;
  }
  return true;
}

        // ==========================================
        // PING PONG GAME - JavaScript –∫–æ–¥ (–û–¢–õ–ê–î–ñ–ï–ù)
        // ==========================================

        // ================= SAFE HOST HELPERS =================
function isSameOrigin(win) {
  try { void win.location.href; return true; } catch (e) { return false; }
}

function safeAwardGameReward(amount, x = 0, y = 0) {
  try {
    if (window.top && window.top !== window && isSameOrigin(window.top) && typeof window.top.awardGameReward === 'function') {
      window.top.awardGameReward(Number(amount) || 0, x, y);
      return;
    }
  } catch (e) { console.warn('safeAwardGameReward direct call failed', e); }

  try {
    (window.parent || window.top).postMessage({ type: 'kspt_award_reward', reward: Number(amount) || 0, x, y }, '*');
    return;
  } catch (e) { console.warn('safeAwardGameReward postMessage failed', e); }

  console.log('Local reward fallback', amount, x, y);
}

function safeAwardGameEK(amount, x = 0, y = 0) {
  try {
    if (window.top && window.top !== window && isSameOrigin(window.top) && typeof window.top.awardGameEK === 'function') {
      window.top.awardGameEK(Number(amount) || 0, x, y); return;
    }
  } catch(e) {}
  try {
    (window.parent || window.top).postMessage({ type: 'ek_award', amount: Number(amount)||0, x, y }, '*'); return;
  } catch(e){}
  console.log('Local EK fallback', amount, x, y);
}

function safeConsumeTicket() {
  try {
    if (window.top && window.top !== window && isSameOrigin(window.top) && typeof window.top.consumeTicketForCurrentGame === 'function') {
      window.top.consumeTicketForCurrentGame();
      return;
    }
  } catch (e) { console.warn('safeConsumeTicket direct call failed', e); }

  try { (window.parent || window.top).postMessage({ type: 'kspt_consume_ticket' }, '*'); return; } catch (e) { console.warn('consumeTicket postMessage failed', e); }

  console.log('consumeTicket fallback (no parent handler)');
}

// –ó–∞–ø—Ä–æ—Å –≤—ã—Ö–æ–¥–∞/–∑–∞–∫—Ä—ã—Ç–∏—è –∏–≥—Ä—ã –∫ —Ö–æ—Å—Ç—É
function safeExitGame() {
  try {
    if (window.top && window.top !== window && isSameOrigin(window.top) && typeof window.top.exitGame === 'function') {
      window.top.exitGame();
      return;
    }
  } catch (e) { console.warn('safeExitGame direct call failed', e); }

  try { (window.parent || window.top).postMessage({ type: 'kspt_exit_game' }, '*'); return; } catch (e) { console.warn('safeExitGame postMessage failed', e); }

  console.log('exitGame fallback (no parent handler)');
}

// –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä—ã (snake.html / pingpong.html)
window.__kspt_hourly = window.__kspt_hourly || 0;

window.addEventListener('message', (ev) => {
  const msg = ev.data;
  if (!msg || typeof msg !== 'object') return;

  if (msg.type === 'kspt_init' || msg.type === 'kspt_hourly_update') {
    const h = Number(msg.hourly) || 0;
    window.__kspt_hourly = h;
  }

  if (msg.type === 'kspt_no_tickets') {
  gameRunning = false;
  gamePaused = true;

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Game Over —ç–∫—Ä–∞–Ω
  const gos = document.getElementById('gameOverScreen');
  if (gos) gos.style.display = 'block';

  alert("Not enough tickets!");
}

  if (msg.type === 'kspt_parent_set_game_over' && msg.blockButtons) {
    document.getElementById('pauseBtn')?.setAttribute('disabled','true');
    document.getElementById('restartBtn')?.setAttribute('disabled','true');
    document.getElementById('exitBtn')?.setAttribute('disabled','true');
  }
});

// –æ–±–Ω–æ–≤–∏–º safeGetOfflinePercent –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä—ã (fallback –Ω–∞ received hourly)
function safeGetOfflinePercent(percent) {
  try {
    // —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–µ—Ä—Ö–Ω–∏–π HOST (same-origin)
    if (typeof HOST !== 'undefined' && HOST !== window && typeof HOST.getOfflinePercent === 'function') {
      return Number(HOST.getOfflinePercent(percent)) || 0;
    }
  } catch (e) { /* ignore */ }

  // fallback: –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ hourly —á–µ—Ä–µ–∑ postMessage
  if (typeof window.__kspt_hourly === 'number') {
    return Math.round((window.__kspt_hourly * (percent/100)) * 100) / 100;
  }

  // –ø–æ—Å–ª–µ–¥–Ω–∏–π fallback: —á–∏—Ç–∞—Ç—å localStorage (–µ—Å–ª–∏ –≤ iframe –¥–æ—Å—Ç—É–ø–µ–Ω)
  try {
    const raw = localStorage.getItem('kspt_data') || localStorage.getItem('d') || null;
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed.offlineHourly === 'number') {
        return Math.round((parsed.offlineHourly * (percent/100)) * 100) / 100;
      }
    }
  } catch(e) {}

  return 0;
}

        // ------------------------------------------
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const playerScoreEl = document.getElementById('playerScore');
        const aiScoreEl = document.getElementById('aiScore');
        const speedEl = document.getElementById('speed');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalPlayerScoreEl = document.getElementById('finalPlayerScore');
        const finalAiScoreEl = document.getElementById('finalAiScore');
        const earnedKSPTEl = document.getElementById('earnedKSPT');
        const earnedEKElem = document.getElementById('earnedEK');

        // Game variables
        let gameRunning = true;
        let animationId = null;
        let gamePaused = false;
        let playerScore = 0;
        let aiScore = 0;
        let gameSpeed = 1.0;
        let ballHits = 0;
        let earnedKSPT = 0;
        let sessionEK = 0; // –î–æ–±–∞–≤–ª–µ–Ω–æ: —Å—á–µ—Ç—á–∏–∫ EK –∑–∞ —Å–µ—Å—Å–∏—é
        const floatingTexts = [];

        // Paddle variables
        const PADDLE_WIDTH = 10;
        const PADDLE_HEIGHT = 60;
        const PADDLE_SPEED = 5;

        let playerPaddle = {
            x: 20,
            y: canvas.height / 2 - PADDLE_HEIGHT / 2,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT,
            speed: PADDLE_SPEED
        };

        let aiPaddle = {
            x: canvas.width - 30,
            y: canvas.height / 2 - PADDLE_HEIGHT / 2,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT,
            speed: PADDLE_SPEED * 0.85
        };

        // Ball variables
        let ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 8,
            speedX: 4,
            speedY: 2,
            color: '#00e676'
        };

        // Joystick variables
        let joystickActive = false;
        let joystickDirection = 0;

        // Initialize joystick
        const joystickArea = document.getElementById('joystickArea');
        const joystickCenter = document.querySelector('.joystick-center');

        joystickArea.addEventListener('touchstart', handleJoystickStart);
        joystickArea.addEventListener('touchmove', handleJoystickMove);
        joystickArea.addEventListener('touchend', handleJoystickEnd);

        joystickArea.addEventListener('mousedown', handleJoystickStart);
        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('mouseup', handleJoystickEnd);

        function handleJoystickStart(e) {
            e.preventDefault();
            joystickActive = true;
            updateJoystick(e);
        }

        function handleJoystickMove(e) {
            if (!joystickActive) return;
            e.preventDefault();
            updateJoystick(e);
        }

        function handleJoystickEnd(e) {
            joystickActive = false;
            joystickDirection = 0;
            joystickCenter.style.transform = 'translate(-50%, -50%)';
        }

        function updateJoystick(e) {
            const rect = joystickArea.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let deltaX = clientX - centerX;
            let deltaY = clientY - centerY;
            
            // Limit to joystick bounds
            const maxDistance = rect.width / 2 - 20;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            // Update joystick center position
            joystickCenter.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
            
            // Calculate direction (-1 to 1)
            joystickDirection = deltaY / maxDistance;
        }

        // Game functions
        function resetBall() {
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;

    // –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî –ù–ï —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ gameSpeed –∑–¥–µ—Å—å
    ball.speedX = (Math.random() > 0.5 ? 1 : -1) * 4;
    ball.speedY = (Math.random() * 2 - 1) * 3;
}

        function updatePaddles() {
            // Update player paddle based on joystick
            playerPaddle.y += joystickDirection * playerPaddle.speed * gameSpeed;
            
            // Keep paddle in bounds
            if (playerPaddle.y < 0) playerPaddle.y = 0;
            if (playerPaddle.y > canvas.height - playerPaddle.height) {
                playerPaddle.y = canvas.height - playerPaddle.height;
            }
            
            // AI paddle follows ball
            const aiPaddleCenter = aiPaddle.y + aiPaddle.height / 2;
            if (aiPaddleCenter < ball.y - 10) {
                aiPaddle.y += aiPaddle.speed * gameSpeed;
            } else if (aiPaddleCenter > ball.y + 10) {
                aiPaddle.y -= aiPaddle.speed * gameSpeed;
            }
            
            // Keep AI paddle in bounds
            if (aiPaddle.y < 0) aiPaddle.y = 0;
            if (aiPaddle.y > canvas.height - aiPaddle.height) {
                aiPaddle.y = canvas.height - aiPaddle.height;
            }
        }
   
        function spawnFloatingText(text, x, y, color = '#00e676') {
            floatingTexts.push({
                text,
                x,
                y,
                alpha: 1,
                rise: 0,
                color
            });
        }

        function updateBall() {
            // Move ball
            ball.x += ball.speedX * gameSpeed;
            ball.y += ball.speedY * gameSpeed;
            
            // Ball collision with top/bottom walls
            if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
                ball.speedY = -ball.speedY;
                playSound('bounce');
                gameVibrate([50]);
            }
            
            // Ball collision with player paddle
            if (ball.x - ball.radius < playerPaddle.x + playerPaddle.width &&
                ball.x + ball.radius > playerPaddle.x &&
                ball.y > playerPaddle.y &&
                ball.y < playerPaddle.y + playerPaddle.height) {
                
                // Calculate hit position (from -1 to 1)
                const hitPos = (ball.y - (playerPaddle.y + playerPaddle.height / 2)) / (playerPaddle.height / 2);
                
                // Change ball direction
                ball.speedX = Math.abs(ball.speedX) * 1.05; // Speed up slightly
                ball.speedY = hitPos * 5;
                
                // Make sure ball goes to the right
                ball.x = playerPaddle.x + playerPaddle.width + ball.radius;
                
                // Award KSPT for hitting the ball (0.5% –æ—Ç offline income)
                const reward = safeGetOfflinePercent(0.5);
                earnedKSPT += reward;
                spawnFloatingText(`+${reward.toFixed(2)}`, canvas.width / 2, canvas.height / 2, '#00e5ff');
                safeAwardGameReward(reward, ball.x, ball.y);
                
                // –ü—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –º—è—á–∞ –ø–æ —Ä–∞–∫–µ—Ç–∫–µ –∏–≥—Ä–æ–∫–∞ ‚Äî —à–∞–Ω—Å 1.3% +1 EK
                if (Math.random() < 0.013) { // 1.3%
                  sessionEK++;
                  safeAwardGameEK(1, ball.x, ball.y);
                  spawnFloatingText('+1 EK', ball.x - 10, ball.y - 10, '#ffd54f');
                }
                
                playSound('apple');
                gameVibrate([30]);
            }        
            // Ball collision with AI paddle
            if (ball.x + ball.radius > aiPaddle.x &&
                ball.x - ball.radius < aiPaddle.x + aiPaddle.width &&
                ball.y > aiPaddle.y &&
                ball.y < aiPaddle.y + aiPaddle.height) {
                
                const hitPos = (ball.y - (aiPaddle.y + aiPaddle.height / 2)) / (aiPaddle.height / 2);
                
                ball.speedX = -Math.abs(ball.speedX) * 1.05;
                ball.speedY = hitPos * 5;
                
                ball.x = aiPaddle.x - ball.radius;
                
                ballHits++;
                if (ballHits % 5 === 0) {
                    gameSpeed = Math.min(gameSpeed + 0.05, 2.0);
                    speedEl.textContent = Math.round(gameSpeed * 100) + '%';
                }
                
                playSound('apple');
                gameVibrate([30]);
            }
            
            // Ball out of bounds (scoring)
            if (ball.x - ball.radius < 0) {
                // AI scores
                aiScore++;
                aiScoreEl.textContent = aiScore;
                playSound('ai_goal');
                gameVibrate([100, 50, 100]);
                
                if (aiScore >= 5) {
                    endGame();
                } else {
                    resetBall();
                }
            } else if (ball.x + ball.radius > canvas.width) {
                // Player scores
                playerScore++;
                playerScoreEl.textContent = playerScore;
                
                // Award KSPT for scoring
                const reward = safeGetOfflinePercent(2.5);
                earnedKSPT += reward;
                spawnFloatingText(`+${reward.toFixed(2)}`, canvas.width / 2, canvas.height / 2, '#00e5ff');
                safeAwardGameReward(reward, ball.x, ball.y);
                playSound('player_goal');
                gameVibrate([200, 100, 200]);
                
                if (playerScore >= 5) {
                    endGame();
                } else {
                    resetBall();
                }
            }
        }

        function draw() {
            // Clear canvas
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw center line
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw paddles
            ctx.fillStyle = '#00bcd4';
            ctx.fillRect(playerPaddle.x, playerPaddle.y, playerPaddle.width, playerPaddle.height);
            
            ctx.fillStyle = '#ff4081';
            ctx.fillRect(aiPaddle.x, aiPaddle.y, aiPaddle.width, aiPaddle.height);
            
            // Draw ball
            ctx.fillStyle = ball.color;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw score markers
            ctx.fillStyle = '#00bcd4';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(playerScore.toString(), canvas.width / 4, 30);
            
            ctx.fillStyle = '#ff4081';
            ctx.fillText(aiScore.toString(), canvas.width * 3 / 4, 30);
            
            // Draw speed indicator
            ctx.fillStyle = '#888';
            ctx.font = '12px Arial';
            ctx.fillText(`Speed: ${Math.round(gameSpeed * 100)}%`, canvas.width / 2, 30);
            
            // Draw ball hits
            ctx.fillStyle = '#ff9800';
            ctx.font = '10px Arial';
            ctx.fillText(`Hits: ${ballHits}`, canvas.width / 2, canvas.height - 10);

            // Floating rewards animation
            for (let i = floatingTexts.length - 1; i >= 0; i--) {
                const f = floatingTexts[i];

                ctx.globalAlpha = f.alpha;
                ctx.fillStyle = f.color;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(f.text, f.x, f.y - f.rise);

                f.rise += 0.5;
                f.alpha -= 0.02;

                if (f.alpha <= 0) {
                    floatingTexts.splice(i, 1);
                }
            }
            ctx.globalAlpha = 1;
        }

        function endGame() {
  if (window.__kspt_gameOverHandled) return;
  window.__kspt_gameOverHandled = true;

  gameRunning = false;

  // –ù–ï –î–û–ë–ê–í–õ–Ø–ï–ú —Ñ–∏–Ω–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É, –µ—Å–ª–∏ –Ω–∞–≥—Ä–∞–¥—ã —É–∂–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø–æ —Ö–æ–¥—É –∏–≥—Ä—ã.
  // earnedKSPT += safeGetOfflinePercent(playerScore > aiScore ? 5 : 2);

  finalPlayerScoreEl.textContent = playerScore;
  finalAiScoreEl.textContent = aiScore;
  earnedKSPTEl.textContent = earnedKSPT.toFixed(2);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ EK
  earnedEKElem.textContent = sessionEK;

  // –ù–ï –í–´–ó–´–í–ê–ï–ú safeConsumeTicket() ‚Äî –±–∏–ª–µ—Ç —É–∂–µ —Å–ø–∏—Å–∞–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (games.js)
  // safeConsumeTicket();

  gameOverScreen.style.display = 'block';

  if (playerScore > aiScore) {
    playSound('win');
    gameVibrate([200,100,200,100,200]);
  } else {
    playSound('lose');
    gameVibrate([300,200,300]);
  }

  try { if (animationId) cancelAnimationFrame(animationId); } catch(e){}
}

        function gameLoop() {
            if (!gamePaused && gameRunning) {
                updatePaddles();
                updateBall();
                draw();
            }
            animationId = requestAnimationFrame(gameLoop);
        }

        // Initialize game
        function initGame() {
            resetBall();
            playerScore = 0;
            aiScore = 0;
            ballHits = 0;
            gameSpeed = 1.0;
            earnedKSPT = 0;
            sessionEK = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ EK
            
            playerScoreEl.textContent = '0';
            aiScoreEl.textContent = '0';
            speedEl.textContent = '100%';
            
            gameOverScreen.style.display = 'none';
            gameRunning = true;
            window.__kspt_gameOverHandled = false;
            
            // Reset paddle positions
            playerPaddle.y = canvas.height / 2 - PADDLE_HEIGHT / 2;
            aiPaddle.y = canvas.height / 2 - PADDLE_HEIGHT / 2;
            
            if (animationId) cancelAnimationFrame(animationId);
            requestAnimationFrame(gameLoop);
        }

        // Button event listeners
        document.getElementById('pauseBtn').addEventListener('click', function() {
            gamePaused = !gamePaused;
            this.textContent = gamePaused ? 'Resume' : 'Pause';
            playSound('bounce');
        });

        document.getElementById('restartBtn').addEventListener('click', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∏–ª–µ—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ
  if (!ensureHasTicketOrWarn()) return;
  
  // –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –±–∏–ª–µ—Ç–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
  // –†–æ–¥–∏—Ç–µ–ª—å —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç –±–∏–ª–µ—Ç—ã –∏ —Å–ø–∏—à–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  try {
    (window.parent || window.top).postMessage({ 
      type: 'kspt_new_round'
    }, '*');
  } catch(e) {
    console.warn('Failed to send new round message', e);
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
  initGame();
});

document.getElementById('exitBtn').addEventListener('click', function() {
    safeExitGame();
});

document.getElementById('playAgainBtn').addEventListener('click', function() {
    gameOverScreen.style.display = 'none';

    // —Å–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—é: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ ‚Üí –Ω—É–∂–µ–Ω –±–∏–ª–µ—Ç
    try {
        (window.parent || window.top).postMessage({ type: 'kspt_new_round' }, '*');
    } catch(e){}

    initGame();
});

document.getElementById('exitToMenuBtn').addEventListener('click', function() {
    safeExitGame();
});

        // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –∑–≤—É–∫–æ–≤ –∏ –≤–∏–±—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞)
        function playSound(soundName) {
            console.log('Sound:', soundName);
        }

        let userInteracted = false;

// –æ—Ç–º–µ—á–∞–µ–º –ø–µ—Ä–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (–æ–¥–∏–Ω —Ä–∞–∑)
function markUserInteracted() {
  userInteracted = true;
}
document.addEventListener('touchstart', markUserInteracted, { once: true, passive: true });
document.addEventListener('mousedown', markUserInteracted, { once: true });

function gameVibrate(pattern) {
  if (!userInteracted) return; // –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∏–±—Ä–∞—Ü–∏—é –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–º —Ñ—Ä–µ–π–º–µ
  if (!('vibrate' in navigator)) return;
  try {
    navigator.vibrate(pattern);
  } catch (e) {
    // –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã/—Å–±–æ—Ä–∫–∏ –º–æ–≥—É—Ç –±—Ä–æ—Å–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–µ–Ω—Ü–∏—é ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    console.warn('vibrate failed or blocked', e);
  }
}
        // –õ–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞, –ù–ï –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ window.top –Ω–∞–ø—Ä—è–º—É—é
        window._local_awardGameReward = window._local_awardGameReward || function (reward, x, y) {
          const r = Number(reward);
          console.log('Reward awarded (local):', isNaN(r) ? reward : r.toFixed(2), 'KSPT at', x, y);
        };

        // Start the game
        initGame();

        // Handle visibility change (pause when tab not visible)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                gamePaused = true;
                document.getElementById('pauseBtn').textContent = 'Resume';
            }
        });
    </script>

<script>
(function(){
  const BASE_W = 360;   // –¥–∏–∑–∞–π–Ω –∏–≥—Ä—ã (—Ç–æ—Ç, —á—Ç–æ —É —Ç–µ–±—è –≤ canvas width)
  const BASE_H = 360;   // –≤—ã—Å–æ—Ç–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è ‚Äî –ø–æ–¥–ø—Ä–∞–≤—å –µ—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

  function fitGameUI() {
    const container = document.querySelector('.game-container') || document.body;
    const header = document.querySelector('.game-header');
    const headerH = header ? header.getBoundingClientRect().height : 0;

    const availW = window.innerWidth;
    const availH = window.innerHeight - headerH - 12; // –Ω–µ–º–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞

    // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± ‚Äî —á—Ç–æ–±—ã –≤—Å—ë –ø–æ–º–µ—Å—Ç–∏–ª–æ—Å—å: –¥–∂–æ–π—Å—Ç–∏–∫ + –∫–Ω–æ–ø–∫–∏ + –∫–∞–Ω–≤–∞—Å
    const scale = Math.min(availW / BASE_W, availH / (BASE_H + 160)); 
    // (160 ‚Äî –ø—Ä–∏–º–µ—Ä –∑–æ–Ω—ã –ø–æ–¥ –¥–∂–æ–π—Å—Ç–∏–∫+–∫–Ω–æ–ø–∫–∏; –µ—Å–ª–∏ —É —Ç–µ–±—è –º–µ–Ω—å—à–µ/–±–æ–ª—å—à–µ ‚Äî –ø–æ–º–µ–Ω—è–π)

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–∑ CSS transform OR (–ª—É—á—à–µ) –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º canvas –∏ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–ø—Ä—è–º—É—é:
    // 1) –µ—Å–ª–∏ —É —Ç–µ–±—è canvas —Å id gameCanvas ‚Äî –º–µ–Ω—è–µ–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
      canvas.style.width = Math.round(BASE_W * scale) + 'px';
      canvas.style.height = Math.round(BASE_H * scale) + 'px';
      // –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è canvas.width/canvas.height ‚Äî –æ–±–Ω–æ–≤–∏ –∏—Ö —Ç–æ–∂–µ
      if (!canvas.dataset.kspt_scaled) {
        // –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç canvas.width (pixel buffer),
        // –æ—Å—Ç–∞–≤—å canvas.width = BASE_W * devicePixelRatio, –Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º style
        canvas.dataset.kspt_scaled = '1';
      }
    }

    // 2) –¥–∂–æ–π—Å—Ç–∏–∫ –∏ –∫–Ω–æ–ø–∫–∏ ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º wrapper
    const joystick = document.getElementById('joystickArea');
    if (joystick) {
      joystick.style.transformOrigin = 'top center';
      joystick.style.transform = `scale(${scale})`;
      joystick.style.margin = '8px auto';
    }

    const btnRow = document.querySelector('.game-buttons') || document.querySelector('.game-buttons-row');
    if (btnRow) {
      btnRow.style.transformOrigin = 'top center';
      btnRow.style.transform = `scale(${scale})`;
      btnRow.style.marginTop = '10px';
    }

    // 3) —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (container) {
      container.style.width = Math.round(BASE_W * scale) + 'px';
      container.style.margin = '0 auto';
      container.classList.add('kspt-safe-bottom');
    }
  }

  // listen parent message to force recalculation (parent –ø–æ—Å—ã–ª–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã)
  window.addEventListener('message', (ev) => {
    const d = ev.data || {};
    if (d && d.type === 'kspt_parent_viewport') {
      // –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ ‚Äî –¥–µ–ª–∞–µ–º fit —á–µ—Ä–µ–∑ 50ms (–ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏)
      setTimeout(fitGameUI, 50);
    }
  });

  // resize on orientation / window resize
  window.addEventListener('resize', fitGameUI);
  window.addEventListener('orientationchange', () => setTimeout(fitGameUI, 120));
  window.addEventListener('load', () => setTimeout(fitGameUI, 80));

  // additionally: prevent overscroll inside iframe (iOS)
  document.addEventListener('touchmove', function(e){
    // allow touch for game controls (they are inside this iframe) ‚Äî –Ω–µ –æ—Ç–º–µ–Ω—è–µ–º,
    // –Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é "—Ä–µ–∑–∏–Ω—É" —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ —Ü–µ–ª—å ‚Äî –Ω–µ —ç–ª–µ–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ–Ω–∫–æ ‚Äî –º–æ–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å touchmove –¥–ª—è .joystick-bg:
    const el = e.target;
    if (el.closest && (el.closest('.joystick-bg') || el.closest('.game-buttons') || el.closest('canvas'))) {
      // allow normal game interaction
      return;
    }
    // otherwise prevent page overscroll
    e.preventDefault();
  }, { passive: false });
})();
</script>

</body>
</html>