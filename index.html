<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KSPT Token</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0b0b0b;
  font-family:Arial,sans-serif;
  color:#fff;
  -webkit-tap-highlight-color: transparent;
  /* Prevent double-tap zoom and manipulation */
  touch-action: manipulation; 
  user-select: none;
}

.app{
  max-width:420px;
  margin:0 auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  padding:16px;
  position: relative;
}

/* ===== COMMON ===== */
.screen{display:none}
.screen.active{display:block}

.top-bar{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:16px;
}
.top-bar img{
  width:32px;
  height:32px;
}
.top-bar span{
  font-size:16px;
  opacity:.85;
}

.balance-main{
  font-size:22px;
  margin:10px 0 5px; /* Adjusted margin for offline text */
  text-align:center;
}

/* NEW: Offline Info Style */
.offline-info {
  text-align: center;
  font-size: 14px;
  color: #aaa;
  margin-bottom: 25px;
}

/* ===== COIN ===== */
.coin{
  width:220px;
  height:220px;
  margin:0 auto 40px;
  display:block;
  transition:transform .08s ease;
  /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –¥–ª—è JS –∞–Ω–∏–º–∞—Ü–∏–∏ */
  cursor: pointer;
}

/* –ö–ª–∞—Å—Å –¥–ª—è JS-–∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞–∂–∞—Ç–∏—è */
.coin.anim {
  transform: scale(0.92);
}

/* ===== BOTTOM BUTTONS ===== */
/* Layout Updated to support two layers */
.bottom-bar{
  margin-top:auto;
  display:flex;
  flex-direction: column;
  /* Changed to column for layers */
  gap:10px; 
}

.button-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.long-btn{
  flex:1;
  height:70px;
  background:#1a1a1a;
  border-radius:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor: pointer;
}
.long-btn img{
  height:42px;
  width:auto;
}

/* ===== CARDS ===== */
.card{
  background:#161616;
  border-radius:18px;
  padding:14px;
  margin-bottom:14px;
  overflow: hidden;
  /* For rectangular images */
}

.card-title{font-weight:bold;margin-bottom:6px}
.card-sub{font-size:13px;opacity:.6;margin-bottom:8px}

/* UPDATED: Fixed Layout for Rectangular Images */
.card-img {
  width: 100px;
  height: 80px; 
  float: right;
  margin-top: 0; /* Removed negative margin to prevent cut-off */
  margin-left: 10px;
  border-radius: 8px;
  object-fit: contain;
  /* Ensures the whole sprite fits */
  background: rgba(255,255,255,0.03);
  /* Slight background to frame the sprite */
}

.card-lvl {
  font-size: 12px;
  color: #ff9800;
  margin-bottom: 4px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#262626;
  color:#fff;
  font-size:15px;
  cursor: pointer;
}

button.active{background:#2e7d32}
button.owned{background:#333;opacity:.6}

.back{
  margin-top:20px;
  opacity:.6;
  background:none;
}

/* ===== BET ===== */
.input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
}

input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:16px;
  background: #fff;
  color: #000;
}

.max-btn {
  width: auto;
  padding: 0 20px;
  background: #ff9800;
  /* –í—ã–¥–µ–ª–∏–º –∫–Ω–æ–ø–∫—É MAX —Ü–≤–µ—Ç–æ–º */
  font-weight: bold;
}

.confirm{
  background:#2e7d32;
  margin-top:8px;
}
.cancel{
  background:#444;
  margin-top:6px;
}

/* ===== NEW FEATURES STYLES ===== */

/* Energy System */
.energy-box {
  position: absolute;
  bottom: 180px; /* Above bottom bars */
  left: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
  font-size: 14px;
  background: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 20px;
  pointer-events: none;
}
.energy-box img {
  width: 20px;
  height: 20px;
}

/* Promo Code */
.promo-box {
  margin-top: 20px;
  padding-top: 10px;
  border-top: 1px solid #333;
}
.promo-input-group {
  display: flex;
  gap: 8px;
}
.promo-input-group input {
  flex: 1;
}
.promo-btn {
  width: auto;
  background: #ff9800;
  color: #000;
  font-weight: bold;
}

/* Anti-Cheat Red Screen */
.red-screen {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: red;
  z-index: 9999;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  text-align: center;
}
.red-screen h1 {
  font-size: 40px;
  margin: 0;
}

</style>
</head>

<body>

<div id="redScreen" class="red-screen">
  <h1>DONT CHEAT!!</h1>
</div>

<div class="app">

<div id="main" class="screen active">
  <div class="balance-main" id="balanceMain">0.00 KSPT</div>
  <div class="offline-info" id="offlineRateMain">Offline: 0.00 KSPT/h</div>

  <img id="coin" class="coin" src="kspt.png" alt="Coin">
  
  <div class="energy-box">
    <img src="ener.png" alt="E">
    <span id="energyDisplay">2500 / 2500</span>
  </div>
  
  <div class="bottom-bar">
    <div class="button-row">
      <div class="long-btn" onclick="openScreen('skins')">
        <img src="m.png" alt="Skins">
      </div>
      <div class="long-btn" onclick="openScreen('offlineShop')">
        <img src="k.png" alt="Mining">
      </div>
    </div>
    <div class="button-row">
      <div class="long-btn" onclick="openScreen('tech')">
         <img src="t.png" alt="Tech">
      </div>
    </div>
  </div>
</div>

<div id="skins" class="screen">
  <div class="top-bar">
    <img src="kspt.png">
    <span id="balanceSkins"></span>
  </div>

  <div class="card">
    <div class="card-title">Default Coin</div>
    <div class="card-sub">Standard (+0 KSPT/h)</div>
    <button id="skin-default" onclick="buySkin('default',0)"></button>
  </div>

  <div class="card">
    <div class="card-title">WHAT IS KSPT</div>
    <div class="card-sub">Price: 1 KSPT (+1 KSPT/h)</div>
    <button id="skin-what" onclick="buySkin('what',1)"></button>
  </div>

  <div class="card">
    <div class="card-title">KSPT Burger Edition</div>
    <div class="card-sub">Price: 10 KSPT (+2.2 KSPT/h)</div>
    <button id="skin-burger" onclick="buySkin('burger',10)"></button>
  </div>

  <div class="card">
    <div class="card-title">Little Aqua</div>
    <div class="card-sub">Price: 30 KSPT (+4 KSPT/h)</div>
    <button id="skin-joost" onclick="buySkin('joost',30)"></button>
  </div>

  <div class="card">
    <div class="card-title">Dogs World</div>
    <div class="card-sub">Price: 80 KSPT (+6.7 KSPT/h)</div>
    <button id="skin-dog" onclick="buySkin('dog',80)"></button>
  </div>

  <div class="card">
    <div class="card-title">Cringe Diamond</div>
    <div class="card-sub">Price: 100 KSPT (+10 KSPT/h)</div>
    <button id="skin-diam" onclick="buySkin('diam',100)"></button>
  </div>
  
  <div class="card">
    <div class="card-title">Meme-Brain</div>
    <div class="card-sub">Price: 240 KSPT (+15 KSPT/h)</div>
    <button id="skin-tung" onclick="buySkin('tung',240)">BUY 240 KSPT</button>
  </div>

  <div class="card">
    <div class="card-title">NUMBER #1!</div>
    <div class="card-sub" id="limitedSkinSub" style="color:#ff9800">Special: Win x10 Bet (+3 KSPT/h)</div>
    <button id="skin-priz" onclick="buySkin('priz',0)">LOCKED</button>
  </div>

  <button class="back" onclick="openScreen('main')">Back</button>
</div>

<div id="offlineShop" class="screen">
  <div class="top-bar">
    <img src="kspt.png">
    <span id="balanceOffline"></span>
  </div>

  <div class="card">
    <img src="per.png" class="card-img">
    <div class="card-title">Personal Manager</div>
    <div class="card-lvl" id="c1_lvl">Not Owned</div>
    <div class="card-sub" id="c1_income">+1.0 KSPT/h</div>
    <button id="btn_c1" onclick="buyCard(1)">Buy 25 KSPT</button>
  </div>

  <div class="card" id="card2_container" style="display:none; filter: grayscale(1);">
    <img src="inv.png" class="card-img">
    <div class="card-title">Investors</div>
    <div class="card-lvl" id="c2_lvl">Locked</div>
    <div class="card-sub" id="c2_income">+2.5 KSPT/h</div>
    <button id="btn_c2" onclick="buyCard(2)">Locked</button>
  </div>

  <div class="card" id="card3_container" style="display:none; filter: grayscale(1);">
    <img src="offi.png" class="card-img">
    <div class="card-title">Office</div>
    <div class="card-lvl" id="c3_lvl">Locked</div>
    <div class="card-sub" id="c3_income">+10.2 KSPT/h</div>
    <button id="btn_c3" onclick="buyCard(3)">Locked</button>
  </div>

  <button class="back" onclick="openScreen('main')">Back</button>
</div>

<div id="tech" class="screen">
  <div class="top-bar">
    <img src="kspt.png">
    <span id="balanceTech"></span>
  </div>

  <div class="card">
    <div class="card-title">Permanent x2</div>
    <div class="card-sub">Price: 5 KSPT</div>
    <button onclick="buyX2()">Buy</button>
  </div>

  <div class="card">
    <div class="card-title">Upgrade Energy</div>
    <div class="card-sub">Max: 8000 | +500 Energy</div>
    <div class="card-sub" id="energyInfoText">Current Max: 2500</div>
    <button onclick="buyEnergyLimit()">Buy (+500) 15 KSPT</button>
  </div>

  <div class="card">
    <div class="card-title">Bet</div>
    <div class="input-group">
      <input id="betAmount" type="number" placeholder="1‚Äì30">
      <button class="max-btn" onclick="setMaxBet()">MAX</button>
    </div>
    
    <button onclick="prepareBet(1.5,30)">x1.5 (30%)</button>
    <button onclick="prepareBet(3,17)">x3 (17%)</button>
    <button onclick="prepareBet(5,8)">x5 (8%)</button>
    <button onclick="prepareBet(10,3)">x10 (3%)</button>
    <button onclick="prepareBet(50,1.1)" style="margin-top:5px; border:1px solid #ff9800; color:#ff9800">x50 (1.1%)</button>
  </div>

  <div id="betConfirm" class="card" style="display:none">
    <div id="betText"></div>
    <button class="confirm" onclick="confirmBet()">Confirm</button>
    <button class="cancel" onclick="cancelBet()">Cancel</button>
  </div>

  <div class="card promo-box">
    <div class="card-title">Enter promo code</div>
    <div class="promo-input-group">
      <input id="promoInput" type="text" placeholder="Code...">
      <button class="promo-btn" onclick="checkPromo()">Apply</button>
    </div>
  </div>

  <button class="back" onclick="openScreen('main')">Back</button>
</div>

</div>

<script>
if (window.Telegram?.WebApp){
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

// Global Skin Counter Initialization
let globalSkinLimit = parseInt(localStorage.getItem("kspt_global_priz_count")) || 50;

// Anti-Cheat Variables
let clickTimes = [];
let cheatStage = parseInt(localStorage.getItem("kspt_cheat_stage")) || 0; // 0=clean, 1=warned, 2=reset, 3=red screen

// Check for Perma Ban on Load
if(cheatStage >= 3) {
  document.getElementById("redScreen").style.display = "flex";
}

// –î–∞–Ω–Ω—ã–µ
let d=JSON.parse(localStorage.getItem("kspt"))||{
 tokens:0,skin:"default",skins:{},x2:false,
 lastLogin: Date.now(),
 wonX10: false,
 cards: { c1: -1, c2: -1 },
 // New Features Data
 energy: 2500,
 maxEnergy: 2500,
 usedCodes: []
};

// Migration for old saves
if(typeof d.lastLogin === 'undefined') d.lastLogin = Date.now();
if(typeof d.wonX10 === 'undefined') d.wonX10 = false;
if(typeof d.cards === 'undefined') d.cards = { c1: -1, c2: -1 };
// Initialize Card 3 if not present
if(typeof d.cards.c3 === 'undefined') d.cards.c3 = -1;
// Initialize Energy
if(typeof d.energy === 'undefined') d.energy = 2500;
if(typeof d.maxEnergy === 'undefined') d.maxEnergy = 2500;
if(typeof d.usedCodes === 'undefined') d.usedCodes = [];

let pendingBet=null;

// Skin Income Data
const SKIN_INCOME = {
  default: 0,
  what: 1,
  burger: 2.2,
  joost: 4,
  dog: 6.7,
  diam: 10,
  tung: 15,
  priz: 3
};
const CARDS = {
  1: {
    levels: [
      { price: 25, income: 1.0 },
      { price: 32, income: 2.1 },
      { price: 40, income: 2.8 },
      { price: 51, income: 4.4 },
      { price: 65, income: 5.1 },
      { price: 80, income: 6.5 }
    ]
  },
  2: {
    levels: [
      { price: 100, income: 2.5 },
      { price: 130, income: 3.8 },
      { price: 170, income: 5.1 },
      { price: 190, income: 6.7 },
      { price: 250, income: 8.0 },
      { price: 315, income: 10.0 }
    ]
  },
  // NEW CARD 3 DATA
  3: {
    levels: [
      { price: 310, income: 10.2 },
      { price: 390, income: 14.1 },
      { price: 480, income: 21 },
      { price: 540, income: 28.6 },
      { price: 610, income: 35.8 },
      { price: 760, income: 50.3 }
    ]
  }
};
const save=()=>localStorage.setItem("kspt",JSON.stringify(d));

// Updated Offline Calculation with Startup Screen and 1-hour minimum
function processOfflineIncome() {
  const now = Date.now();
  const diffMs = now - d.lastLogin;
  const hours = diffMs / (1000 * 60 * 60);

  let rate = getHourlyRate();
  // Condition: Only add if hours >= 1
  if (rate > 0 && hours >= 1) {
    let effectiveHours = hours;
    if (effectiveHours > 8) effectiveHours = 8;
    
    let earnings = rate * effectiveHours;
    if (earnings > 0.01) {
       d.tokens += earnings;
       // Requirement: Show earnings popup on startup
       alert(`While you were away, you earned ${earnings.toFixed(2)} KSPT.`);
    }
  }

  // Energy Offline Logic
  if (hours >= 2) {
    d.energy = d.maxEnergy; // Restore to 100%
  } else if (hours >= 1) {
    // Restore to 50% if currently below 50%, or keep if higher? 
    // "After 1 hour energy restores to 50%" - usually implies a set point. 
    // We will set it to max * 0.5 only if current is lower.
    if(d.energy < d.maxEnergy * 0.5) {
      d.energy = Math.floor(d.maxEnergy * 0.5);
    }
  }

  d.lastLogin = now;
  save();
}

function getHourlyRate() {
  let rate = 0;
  // Card Income
  if(d.cards.c1 >= 0) rate += CARDS[1].levels[d.cards.c1].income;
  if(d.cards.c2 >= 0) rate += CARDS[2].levels[d.cards.c2].income;
  if(d.cards.c3 >= 0) rate += CARDS[3].levels[d.cards.c3].income;

  // Skin Stacked Income
  // 1. Default (Always Owned)
  rate += SKIN_INCOME.default;
  // 2. Purchased Skins
  for(let s in d.skins) {
      if(d.skins[s] && SKIN_INCOME[s]) {
          rate += SKIN_INCOME[s];
      }
  }

  // 3. Prize Skin (Special condition)
  if(d.wonX10) rate += SKIN_INCOME.priz;

  return rate;
}

processOfflineIncome();
setInterval(() => {
  d.lastLogin = Date.now();
  save();
}, 60000);

// Online Energy Regeneration (4 per second)
setInterval(() => {
  if (d.energy < d.maxEnergy) {
    d.energy += 4;
    if (d.energy > d.maxEnergy) d.energy = d.maxEnergy;
    ui();
  }
}, 1000);

function ui(){
 balanceMain.innerText=d.tokens.toFixed(2)+" KSPT";
 balanceSkins.innerText="Balance: "+d.tokens.toFixed(2)+" KSPT";
 balanceTech.innerText="Balance: "+d.tokens.toFixed(2)+" KSPT";
 document.getElementById("balanceOffline").innerText="Balance: "+d.tokens.toFixed(2)+" KSPT";

 let rate = getHourlyRate();
 document.getElementById("offlineRateMain").innerText = "Offline: " + rate.toFixed(1) + " KSPT/h";
 // Exclusive Counter UI
 document.getElementById("limitedSkinSub").innerText = `Special: Win x10 Bet (Limited ${globalSkinLimit} left) (+3 KSPT/h)`;

 // Update Energy UI
 document.getElementById("energyDisplay").innerText = `${Math.floor(d.energy)} / ${d.maxEnergy}`;
 document.getElementById("energyInfoText").innerText = `Current Max: ${d.maxEnergy}`;

 let imgName = "kspt.png";
 if(d.skin === "what") imgName = "what.png";
 else if(d.skin === "burger") imgName = "burger.png";
 else if(d.skin === "joost") imgName = "joost.png";
 else if(d.skin === "dog") imgName = "dog.png";
 else if(d.skin === "diam") imgName = "diam.png";
 else if(d.skin === "priz") imgName = "priz.png";
 else if(d.skin === "tung") imgName = "tung.png";
 // Meme-Brain base
 
 // Don't overwrite if it's currently animating tung
 if (d.skin === "tung" && coin.src.includes("tung1.png")) {
    // keep tung1
 } else {
    coin.src = imgName;
 }

 ["default", "what","burger", "joost", "dog", "diam", "tung", "priz"].forEach(s=>{
  let b=document.getElementById("skin-"+s);
  if (!b) return;

  if(s === "priz") {
      if(d.skin === "priz") {
          b.textContent = "ACTIVE";
          b.className = "active";
          return;
      }
      if(d.wonX10 && globalSkinLimit > 0) {
         b.textContent = "OWNED"; 
         
         b.className = "owned";
         b.onclick = function(){ buySkin('priz', 0); };
      } else {
         b.textContent = globalSkinLimit <= 0 ? "SOLD OUT" : "LOCKED (Win x10)";
         b.className = "owned";
         b.onclick = null;
      }
      return;
  }

  if(d.skin===s){
    b.textContent="ACTIVE";
    b.className="active";
  }
  else if(s === "default" || d.skins[s]){
 
    b.textContent="OWNED";
    b.className="owned";
  }
  else{
    let prices = {what:1, burger:10, joost:30, dog:80, diam:100, tung:240};
    b.textContent=`BUY ${prices[s]} KSPT`;
    b.className="";
 }
 });

 updateCardUI();
}

function updateCardUI() {
  const renderCard = (id, cardKey) => {
    let lvl = d.cards[cardKey];
    let data = CARDS[id].levels;
    let btn = document.getElementById("btn_c"+id);
    let txtLvl = document.getElementById(id===1 ? "c1_lvl" : (id===2 ? "c2_lvl" : "c3_lvl"));
    let txtInc = document.getElementById(id===1 ? "c1_income" : (id===2 ? "c2_income" : "c3_income"));
    if (lvl === 5) {
      txtLvl.innerText = "Level: MAX";
      txtInc.innerText = "+" + data[5].income + " KSPT/h";
      btn.innerText = "MAXED";
      btn.className = "owned";
      btn.onclick = null;
    } else {
      let nextLvl = lvl + 1;
      let cost = data[nextLvl].price;
      let nextInc = data[nextLvl].income;
      
      if(lvl === -1) {
        txtLvl.innerText = "Not Owned";
        txtInc.innerText = "+" + nextInc + " KSPT/h";
        btn.innerText = `Buy ${cost} KSPT`;
      } else {
        txtLvl.innerText = `Level: ${lvl}`;
        txtInc.innerText = `Current: +${data[lvl].income} -> +${nextInc}`;
        btn.innerText = `Upgrade ${cost} KSPT`;
      }
      btn.className = "";
      btn.onclick = function() { buyCard(id); };
    }
  };

  renderCard(1, "c1");

  // Card 2 Logic
  let c2Div = document.getElementById("card2_container");
  if (d.cards.c1 >= 3) {
      c2Div.style.display = "block";
      c2Div.style.filter = "none";
      renderCard(2, "c2");
  } else {
      c2Div.style.display = "block";
      c2Div.style.filter = "grayscale(1) opacity(0.5)";
      document.getElementById("btn_c2").innerText = "Unlock: Card #1 Lvl 3";
      document.getElementById("btn_c2").onclick = null;
  }

  // Card 3 Logic
  let c3Div = document.getElementById("card3_container");
  // Condition: Investors (Card 2) >= Level 2 (index 1)
  if (d.cards.c2 >= 1) {
      c3Div.style.display = "block";
      c3Div.style.filter = "none";
      renderCard(3, "c3");
  } else {
      c3Div.style.display = "block";
      c3Div.style.filter = "grayscale(1) opacity(0.5)";
      document.getElementById("btn_c3").innerText = "Unlock: Card #2 Lvl 2";
      document.getElementById("btn_c3").onclick = null;
  }
}

function buyCard(id) {
  let key = "c" + id;
  let curLvl = d.cards[key];
  if(curLvl >= 5) return;
  let nextLvl = curLvl + 1;
  let cost = CARDS[id].levels[nextLvl].price;
  if(d.tokens >= cost) {
    d.tokens -= cost;
    d.cards[key] = nextLvl;
    save();
    ui();
  }
}

ui();

function openScreen(id){
 document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
 ui();
 d.lastLogin = Date.now();
 save();
}

// Multi-touch Protection
document.getElementById('coin').addEventListener('touchstart', function(e) {
  if (e.touches.length > 2) {
    e.preventDefault();
    return false;
  }
}, {passive: false});

coin.onclick=()=>{
 // Anti-Cheat: Red Screen check
 if(cheatStage >= 3) return;

 // Energy Check
 if (d.energy <= 0) return;

 // Anti-Cheat: Rapid Click Detection
 const now = Date.now();
 clickTimes.push(now);
 // Remove clicks older than 10 seconds
 clickTimes = clickTimes.filter(t => now - t <= 10000);
 
 if(clickTimes.length > 100) {
    // Punishment Logic
    if(cheatStage === 0) {
        alert("Warning: You are clicking too fast! This is not allowed.");
        cheatStage = 1;
        localStorage.setItem("kspt_cheat_stage", 1);
        clickTimes = []; // Reset counter to give a chance
    } else if (cheatStage === 1) {
        // Reset Progress
        d.tokens = 0;
        d.skins = {};
        d.skin = "default";
        d.cards = {c1:-1, c2:-1, c3:-1};
        d.energy = 2500;
        save();
        alert("Account Reset due to cheating!");
        cheatStage = 2;
        localStorage.setItem("kspt_cheat_stage", 2);
        clickTimes = [];
        ui();
    } else if (cheatStage >= 2) {
        // Red Screen
        cheatStage = 3;
        localStorage.setItem("kspt_cheat_stage", 3);
        document.getElementById("redScreen").style.display = "flex";
        return;
    }
 }

 // Deduct Energy
 d.energy--;

 let m=d.x2?2:1;
 d.tokens+=0.01*m;
 
 // Meme-Brain Animation Toggle
 if(d.skin === "tung") {
    if(coin.src.includes("tung.png")) coin.src = "tung1.png";
    else coin.src = "tung.png";
 }

 coin.classList.add('anim');
 setTimeout(() => { coin.classList.remove('anim'); }, 80);
 d.lastLogin = Date.now();
 save();ui();
};
function buySkin(s,c){
 if(s === "default") {
    d.skin = "default";
 }
 else if(s === "priz") {
    if(d.wonX10 && globalSkinLimit > 0) d.skin = "priz";
 }
 else if(d.skins[s]) {
    d.skin=s;
 }
 else if(d.tokens>=c){
  d.tokens-=c;
  d.skins[s]=1;
  d.skin=s;
 }
 save();ui();
}

function buyX2(){
 if(!d.x2 && d.tokens>=5){
  d.tokens-=5;
  d.x2=true;
  save();ui();
 }
}

function setMaxBet() {
  let max = 30;
  if (d.tokens < 30) max = Math.floor(d.tokens);
  if (max < 1) max = 1;
  betAmount.value = max;
}

function prepareBet(mult,ch){
 let a=+betAmount.value;
 if(a<1||a>30||a>d.tokens)return;
 pendingBet={a,mult,ch};
 betText.innerText=`Bet ${a} KSPT with x${mult}?`;
 betConfirm.style.display="block";
}

function cancelBet(){
 pendingBet=null;
 betConfirm.style.display="none";
}

function confirmBet(){
 let {a,mult,ch}=pendingBet;
 betConfirm.style.display="none";
 pendingBet=null;
 d.tokens-=a;
 if(Math.random()*100<ch){
   d.tokens+=a*mult;
   if(mult === 10) {
     if(!d.wonX10 && globalSkinLimit > 0) {
       d.wonX10 = true;
       // Decrement Global Counter
       globalSkinLimit--;
       localStorage.setItem("kspt_global_priz_count", globalSkinLimit);
       alert("üéâ UNBELIEVABLE! You won x10!\nSkin 'NUMBER #1!' Unlocked!");
     }
   }
 }
 save();ui();
}

// NEW FUNCTIONS

function checkPromo() {
  const code = document.getElementById("promoInput").value.trim();
  if(!code) return;

  // Check if used
  if(d.usedCodes.includes(code)) {
    alert("This promo code has already been used.");
    return;
  }

  // Handle special case (no usedCodes tracking for reset code needed usually, but logic below)
  if(code === "ksptshit") {
    if(confirm("Are you sure?")) {
      if(confirm("WARNING: All coins, skins, and progress will be reset. Proceed?")) {
        localStorage.removeItem("kspt");
        location.reload(); 
      }
    }
    return;
  }

  let reward = 0;
  let valid = false;

  switch(code) {
    case "skibidi":
      reward = 1; valid = true; break;
    case "brainrot":
      reward = 1; valid = true; break;
    case "einarald":
      reward = 10; valid = true; break;
    case "sorryfor300":
      reward = 300; valid = true; break;
    case "OnlyforrRed":
      reward = 5000; valid = true; break;
    default:
      alert("Invalid code");
      return;
  }

  if(valid) {
    d.tokens += reward;
    d.usedCodes.push(code);
    save();
    ui();
    alert(`Success! +${reward} KSPT`);
    document.getElementById("promoInput").value = "";
  }
}

function buyEnergyLimit() {
  if (d.tokens >= 15 && d.maxEnergy < 8000) {
    d.tokens -= 15;
    d.maxEnergy += 500;
    save();
    ui();
  } else if (d.maxEnergy >= 8000) {
    alert("Maximum energy limit reached!");
  }
}
</script>
</body>
</html>
